name: Daily Random Commit (Debug)

on:
  schedule:
    - cron: "0 2 * * *"   # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è§¦å‘
  workflow_dispatch:       # æ‰‹åŠ¨è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Git
        run: |
          echo "ğŸ”§ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "jvbaoge1"
          git config --global user.email "shhshz1@163.com"
          git config --list

      - name: Random wait (skip if manual)
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MINUTES=$((RANDOM % 720))   # 0~719 åˆ†é’Ÿ (0~12 å°æ—¶)
            echo "â³ éšæœºç­‰å¾… $MINUTES åˆ†é’Ÿ..."
            sleep ${MINUTES}m
          else
            echo "æ‰‹åŠ¨è§¦å‘ â†’ è·³è¿‡ç­‰å¾…"
          fi

      - name: Generate guaranteed change
        run: |
          mkdir -p changes
          FILE="changes/dummy-$(date +%Y%m%d-%H%M%S).txt"
          echo "Commit at $(date)" > $FILE
          echo "Random: $RANDOM" >> $FILE
          echo "âœ… å·²ç”Ÿæˆæ–‡ä»¶: $FILE"

          # 50% æ¦‚ç‡ä¿®æ”¹å·²æœ‰æ–‡ä»¶
          if [ $((RANDOM % 2)) -eq 0 ]; then
            TARGET=$(find . -type f ! -path "./.git/*" ! -name "$FILE" | shuf -n 1 || true)
            if [ -n "$TARGET" ]; then
              echo "âœï¸ ä¿®æ”¹æ—§æ–‡ä»¶: $TARGET"
              echo "// extra change at $(date)" >> "$TARGET"
            fi
          fi

      - name: Commit and Push changes
        run: |
          set -x   # ğŸ‘€ å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¼šæ‰“å°
          MESSAGES=("update notes" "fix script" "add new data" "refactor code" "update log" "random commit" "improve config" "test changes")
          COMMIT_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}

          git add -A
          git status

          # æäº¤
          git commit -m "$COMMIT_MSG at $(date)" || echo "âš ï¸ Nothing to commit"

          # é¿å…è½åè¿œç¨‹å¯¼è‡´ push å¤±è´¥
          git pull --rebase origin HEAD || true

          # æ¨é€å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          git push origin HEAD --verbose
