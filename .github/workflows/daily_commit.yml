name: Daily Random Commit

on:
  schedule:
    - cron: "0 10 * * *"   # 每天 UTC 10:00 (北京时间 18:00) 固定触发
  workflow_dispatch:       # 支持手动运行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "jvbaoge1"
          git config --global user.email "shhshz1@163.com "   # 改成你绑定的邮箱

      - name: Random wait (skip if manual)
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # 随机等待 0 ~ 5 小时（18:00 ~ 23:00）
            MINUTES=$((RANDOM % 301))
            echo "⏳ 等待 $MINUTES 分钟再提交..."
            sleep ${MINUTES}m
          else
            echo "手动触发 → 跳过等待"
          fi

      - name: Generate guaranteed change
        run: |
          # 每天生成一个新的 dummy 文件，保证有改动
          FILE="dummy-$(date +%Y%m%d).txt"
          echo "Commit at $(date)" > $FILE
          echo "Random: $RANDOM" >> $FILE
          echo "✅ 保证提交文件: $FILE"

          # 50% 概率修改一个已有文件
          if [ $((RANDOM % 2)) -eq 0 ]; then
            TARGET=$(ls | grep -v "$FILE" | shuf -n 1 || true)
            if [ -n "$TARGET" ]; then
              echo "✏️ 修改旧文件: $TARGET"
              echo "// extra change at $(date)" >> "$TARGET"
            else
              echo "ℹ️ 仓库里没有其他文件，跳过旧文件修改"
            fi
          fi

      - name: Commit changes
        run: |
          # 随机挑选 commit message
          MESSAGES=("update notes" "fix script" "add new data" "refactor code" "update log" "random commit" "improve config" "test changes")
          COMMIT_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}

          git add .
          git commit -m "$COMMIT_MSG at $(date)" || echo "⚠️ Nothing to commit"
          git push
