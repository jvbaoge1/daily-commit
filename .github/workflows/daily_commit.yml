name: Daily Random Commit

on:
  schedule:
    - cron: "0 10 * * *"   # 每天 UTC 10:00 触发（北京时间 18:00）
  workflow_dispatch:        # 手动触发按钮

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Decide whether to wait
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "手动触发 → 跳过等待，立即提交 🚀"
          else
            RANDOM_HOUR=$(( RANDOM % 6 ))
            RANDOM_MIN=$(( RANDOM % 60 ))
            TOTAL_SEC=$(( RANDOM_HOUR*3600 + RANDOM_MIN*60 ))
            echo "⏳ 定时触发 → 等待 $RANDOM_HOUR 小时 $RANDOM_MIN 分钟后提交"
            sleep $TOTAL_SEC
          fi

      - name: Generate pseudo code & update README
        run: |
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          echo "" >> README.md
          echo "## Daily Commit - $NOW" >> README.md

          # 随机生成 2~5 段伪代码
          NUM_PARAGRAPHS=$(( (RANDOM % 4) + 2 ))
          for ((p=1; p<=NUM_PARAGRAPHS; p++))
          do
            echo "" >> README.md
            echo "- [${NOW}] Pseudo code paragraph $p:" >> README.md

            # 每段 2~5 行伪代码
            NUM_LINES=$(( (RANDOM % 4) + 2 ))
            for ((i=1; i<=NUM_LINES; i++))
            do
              VAR="var$((RANDOM % 100))"
              FUNC="func$((RANDOM % 50))"
              NUM=$((RANDOM % 100))
              echo "  $VAR = $FUNC($NUM)" >> README.md
            done

            # 随机日志 + emoji
            EMOJIS=("✨" "🔥" "🚀" "🐛" "✅" "🔧" "📦" "📝" "💡" "🎉")
            LOGS=("优化了代码" "修复了一个小问题" "新增了功能" "改进了性能" "整理了注释" "更新了逻辑")
            RAND_EMOJI=${EMOJIS[$RANDOM % ${#EMOJIS[@]}]}
            RAND_LOG=${LOGS[$RANDOM % ${#LOGS[@]}]}
            echo "  Note: $RAND_LOG $RAND_EMOJI" >> README.md
          done

      - name: Commit & Push changes
        run: |
          git add README.md
          git commit -m "chore: daily update $(date '+%Y-%m-%d %H:%M:%S')" || echo "⚠️ Nothing to commit"
          git pull --rebase origin main || true
          git push origin main || echo "⚠️ Push failed"
